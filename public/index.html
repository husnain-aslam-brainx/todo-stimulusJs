<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
      import {
        Application,
        Controller,
      } from "https://unpkg.com/@hotwired/stimulus/dist/stimulus.js";
      window.Stimulus = Application.start();

      Stimulus.register(
        "todo",
        class extends Controller {
          static targets = [
            "description",
            "show",
            "mainButton",
            "span",
            "entity",
          ];

          initialize() {
            this.tasks = [];
          }

          connect() {}

          listenEvent(event) {
            if (event.key === "Enter") {
              this.mainButtonTarget.click();
            }
          }

          addTask() {
            const taskHtml = `
    <span data-action="click->todo#edit" data-todo-target="span" class="pt-2" >${this.description}</span>
    <div>
    <button data-action="todo#completed" class="text-white bg-gradient-to-r from-cyan-400 via-cyan-500 to-cyan-600 hover:bg-gradient-to-br focus:ring-4 focus:outline-none focus:ring-cyan-300 dark:focus:ring-cyan-800 font-medium rounded-lg text-sm p-2 text-center me-2 mb-2 mt-1">Completed</button>
    <button data-action="todo#delete" class="text-white bg-gradient-to-r from-red-400 via-red-500 to-red-600 hover:bg-gradient-to-br focus:ring-4 focus:outline-none focus:ring-red-300 dark:focus:ring-red-800 font-medium rounded-lg text-sm p-2 text-center me-2 mb-2">Delete</button>
    </div>
  `;
            this.tasks.unshift(taskHtml);
            this.descriptionTarget.value = "";
            this.updateShowTarget();
          }

          delete(event) {
            const parent = event.target.closest("[data-todo-target]");
            const index = parseInt(parent.getAttribute("index"), 10);
            this.tasks.splice(index, 1);
            this.updateShowTarget();
          }

          completed(event) {
            const parent = event.target.closest('[data-todo-target="entity"]');
            const index = parseInt(parent.getAttribute("index"), 10);
            const spanElement = parent.querySelector("span");

            spanElement.innerHTML = `<del class="mt-2">${spanElement.textContent}</del>`;

            const taskHtml = `
    <del class="pt-2" >${spanElement.textContent}</del>
    <div>
      <button class="bg-gray-300  cursor-not-allowed opacity-50 font-medium rounded-lg text-sm p-2 text-center me-2 mb-2 mt-1" disabled>
     Completed
    </button>
    <button class="bg-gray-300 rounded-md cursor-not-allowed opacity-50 font-medium rounded-lg text-sm p-2 text-center me-2 mb-2 mt-1" disabled>
  Delete
</button>
    </div>
  `;

            this.tasks[index] = taskHtml;
            this.updateShowTarget();
          }

          edit(event) {
            const parent = event.target.closest('[data-todo-target="entity"]');
            const index = parseInt(parent.getAttribute("index"), 10);
            const description = parent.querySelector("span").innerHTML;

            const edit_field = `<input type="text" value="${description}" id="edit-input" /> 
  <button data-action="todo#update" id="edit-button" class="text-white bg-gradient-to-r from-green-400 via-green-500 to-green-600 hover:bg-gradient-to-br focus:ring-4 focus:outline-none focus:ring-green-300 dark:focus:ring-green-800 font-medium p-2 m-2 rounded text-sm">Update</button>`;
            this.tasks[index] = edit_field;
            this.mainButton.disabled = true;
            this.updateShowTarget();

            const editInput = this.element.querySelector("#edit-input");
            const editButton = this.element.querySelector("#edit-button");
            editInput.addEventListener("keypress", (event) => {
              if (event.key === "Enter") {
                editButton.click();
              }
            });
          }

          update(event) {
            const updated_description =
              document.getElementById("edit-input").value;
            const parent = event.target.closest("[data-todo-target]");
            const index = parseInt(parent.getAttribute("index"), 10);
            const updated_entry = `<span data-action="click->todo#edit class="inline-block pt-2">${updated_description}</span>
  <div>
    <button data-action="todo#completed" class="text-white bg-gradient-to-r from-cyan-400 via-cyan-500 to-cyan-600 hover:bg-gradient-to-br focus:ring-4 focus:outline-none focus:ring-cyan-300 dark:focus:ring-cyan-800 font-medium rounded-lg text-sm p-2 text-center me-2 mb-2 mt-1">Completed</button>
    <button data-action="todo#delete" class="text-white bg-gradient-to-r from-red-400 via-red-500 to-red-600 hover:bg-gradient-to-br focus:ring-4 focus:outline-none focus:ring-red-300 dark:focus:ring-red-800 font-medium rounded-lg text-sm p-2 text-center me-2 mb-2">Delete</button>
    </div>
  `;
            this.tasks[index] = updated_entry;
            this.mainButton.disabled = false;
            this.updateShowTarget();
          }

          updateShowTarget() {
            this.showTarget.innerHTML = "";
            this.tasks.forEach((element, index) => {
              const taskElement = document.createElement("div");
              taskElement.setAttribute("index", index);
              taskElement.classList.add("flex");
              taskElement.classList.add("justify-between");
              taskElement.classList.add("flex-wrap");
              taskElement.classList.add("w-full");
              taskElement.setAttribute("data-todo-target", "entity");
              taskElement.innerHTML = element;
              this.showTarget.appendChild(taskElement);
            });
          }

          get description() {
            return this.descriptionTarget.value;
          }
          get mainButton() {
            return this.mainButtonTarget;
          }
        }
      );
    </script>
    <script src="todo_controller.js" defer></script>
  </head>
  <body>
    <div
      data-controller="todo"
      class="max-w-md mx-auto bg-white shadow-lg rounded-lg overflow-hidden mt-16"
    >
      <div class="px-4 py-2">
        <h1 class="text-gray-800 font-bold text-2xl uppercase">To-Do List</h1>
      </div>
      <div
        class="flex items-center border-b-2 border-teal-500 py-1 mb-3 w-full max-w-sm mx-auto px-4"
      >
        <input
          type="text"
          data-todo-target="description"
          data-action="keydown->todo#listenEvent"
          class="appearance-none bg-transparent border-none w-full text-gray-700 mr-3 px-2 leading-tight focus:outline-none"
        />
        <button
          data-action="todo#addTask"
          data-todo-target="mainButton"
          class="text-white bg-gradient-to-r from-green-400 via-green-500 to-green-600 hover:bg-gradient-to-br focus:ring-4 focus:outline-none focus:ring-green-300 dark:focus:ring-green-800 font-medium p-3 rounded text-sm"
        >
          Add
        </button>
      </div>
      <div data-todo-target="show" class="divide-y divide-gray-200 px-8"></div>
    </div>
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const application = Stimulus.Application.start();
        import("./todo_controller.js")
          .then((module) => {
            application.register("todo", module.default);
          })
          .catch((error) => console.error(error));
      });
    </script>
  </body>
</html>
